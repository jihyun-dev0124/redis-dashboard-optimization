<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>dashboard</title>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
<div class="flex min-h-screen">
    <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” -->
    <aside class="w-60 bg-white border-r border-gray-200 flex flex-col">
        <div class="px-4 py-4 border-b">
            <h1 class="text-lg font-bold text-gray-800">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
            <p class="text-xs text-gray-400 mt-1">Admin Panel</p>
        </div>

        <nav class="flex-1 px-2 py-4 space-y-1 text-sm">
            <!-- ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ ë©”ë‰´ (í˜„ì¬ í˜ì´ì§€ë¼ê³  ê°€ì •, ê°•ì¡°) -->
            <a href="/admin/dashboard/sales"
               class="flex items-center px-3 py-2 rounded-lg text-gray-600 hover:bg-gray-100">
                <span class="mr-2">ğŸ’°</span>
                <span>ë§¤ì¶œ ëŒ€ì‹œë³´ë“œ</span>
            </a>
            <!-- íšŒì› ëŒ€ì‹œë³´ë“œ ë©”ë‰´ -->
            <a href="/admin/dashboard/members"
               class="flex items-center px-3 py-2 rounded-lg bg-blue-50 text-blue-600 font-semibold">
                <span class="mr-2">ğŸ‘¤</span>
                <span>íšŒì› ëŒ€ì‹œë³´ë“œ</span>
            </a>
        </nav>

        <div class="px-4 py-3 border-t text-xs text-gray-400">
            &copy; 2025 My Admin
        </div>
    </aside>

    <!-- ì˜¤ë¥¸ìª½ ë©”ì¸ ì˜ì—­ -->
    <main class="flex-1 px-6 py-6">
        <div class="max-w-6xl mx-auto">
            <!-- í—¤ë” -->
            <header class="mb-8 flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">íšŒì› ëŒ€ì‹œë³´ë“œ</h2>
                    <p class="text-sm text-gray-500 mt-1">ì˜¤ëŠ˜ ê¸°ì¤€ íšŒì› ê°€ì… í†µê³„ì…ë‹ˆë‹¤.</p>
                </div>
            </header>

            <!-- ìƒë‹¨ ìš”ì•½ ì¹´ë“œ (ì´/ì˜¤ëŠ˜/ì–´ì œ) -->
            <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-white rounded-2xl shadow p-4">
                    <p class="text-sm text-gray-500">ì´ íšŒì› ìˆ˜</p>
                    <p id="totalMembers" class="mt-2 text-2xl font-bold text-gray-800">-</p>
                </div>
                <div class="bg-white rounded-2xl shadow p-4">
                    <p class="text-sm text-gray-500">ì˜¤ëŠ˜ ê°€ì…</p>
                    <p id="signupsToday" class="mt-2 text-2xl font-bold text-gray-800">-</p>
                </div>
                <div class="bg-white rounded-2xl shadow p-4">
                    <p class="text-sm text-gray-500">ì–´ì œ ê°€ì…</p>
                    <p id="signupsYesterday" class="mt-2 text-2xl font-bold text-gray-800">-</p>
                </div>
            </section>

            <!-- í•˜ë‹¨: ê·¸ë˜í”„ ì˜ì—­ -->
            <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">

                <!-- ìµœê·¼ 4ì£¼ íšŒì›ê°€ì… ì¶”ì´ (ë¼ì¸/ì—ì–´ë¦¬ì–´ ëŠë‚Œ) -->
                <div class="bg-white rounded-2xl shadow p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">ìµœê·¼ 4ì£¼ íšŒì›ê°€ì… ì¶”ì´</h3>
                        <span class="text-xs text-gray-400">3ì£¼ ì „ ~ ì´ë²ˆì£¼</span>
                    </div>
                    <div class="h-64">
                        <canvas id="weeklySignupChart"></canvas>
                    </div>
                </div>

                <!-- ìµœê·¼ 3ê°œì›” íšŒì›ê°€ì… ì¶”ì´ (ë§‰ëŒ€ ê·¸ë˜í”„) -->
                <div class="bg-white rounded-2xl shadow p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">ìµœê·¼ 3ê°œì›” íšŒì›ê°€ì… ì¶”ì´</h3>
                        <span class="text-xs text-gray-400">ì´ë²ˆë‹¬ / ì§€ë‚œë‹¬ / ìµœê·¼ 3ê°œì›”</span>
                    </div>
                    <div class="h-64">
                        <canvas id="monthlySignupChart"></canvas>
                    </div>
                </div>
            </section>

        </div>
    </main>
</div>


<script>
    function formatCount(value) {
        if(value == null) return "-";
        return Number(value).toLocaleString('ko-KR') + " ëª…";
    }

    async function loadMemberDashboard() {
        try {
            const res = await fetch("/api/dashboard/members");
            if(!res.ok){
                throw new Error("íšŒì› ëŒ€ì‹œë³´ë“œ API í˜¸ì¶œ ì‹¤íŒ¨");
            }

            const data = await res.json();

            //ìƒë‹¨ ì¹´ë“œ ë°”ì¸ë”©
            document.getElementById("totalMembers").textContent = formatCount(data.totalMembers);
            document.getElementById("signupsToday").textContent = formatCount(data.signupsToday);
            document.getElementById("signupsYesterday").textContent = formatCount(data.signupsYesterday);

            // ===== ìµœê·¼ 4ì£¼ íšŒì›ê°€ì… ì¶”ì´ (ë¼ì¸ + ì˜ì—­) =====
            const weeklyLabels = ['3ì£¼ ì „', '2ì£¼ ì „', '1ì£¼ ì „', 'ì´ë²ˆì£¼'];
            const weeklyValues = [
                data.signups3WeeksAgo,
                data.signups2WeeksAgo,
                data.signups1WeekAgo,
                data.signupsThisWeek
            ];

            const weeklyCtx = document.getElementById('weeklySignupChart').getContext('2d');

            new Chart(weeklyCtx, {
                type: 'line',
                data: {
                    labels: weeklyLabels,
                    datasets: [{
                        label: 'ì£¼ê°„ ê°€ì… ìˆ˜',
                        data: weeklyValues,
                        tension: 0.3,
                        fill: true,      // ì˜ì—­ ê·¸ë˜í”„ ëŠë‚Œ
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return value.toLocaleString('ko-KR') + ' ëª…';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const value = context.parsed.y || 0;
                                    return value.toLocaleString('ko-KR') + ' ëª…';
                                }
                            }
                        }
                    }
                }
            });

            // ===== ìµœê·¼ 3ê°œì›” íšŒì›ê°€ì… ì¶”ì´ (ë§‰ëŒ€) =====
            const monthlyLabels = ['ì´ë²ˆë‹¬', 'ì§€ë‚œë‹¬', 'ìµœê·¼ 3ê°œì›”'];
            const monthlyValues = [
                data.signupsThisMonth,
                data.signupsLastMonth,
                data.signupsLast3Month
            ];

            const monthlyCtx = document.getElementById('monthlySignupChart').getContext('2d');

            new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: monthlyLabels,
                    datasets: [{
                        label: 'ì›”ê°„ ê°€ì… ìˆ˜',
                        data: monthlyValues,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return value.toLocaleString('ko-KR') + ' ëª…';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const value = context.parsed.y || 0;
                                    return value.toLocaleString('ko-KR') + ' ëª…';
                                }
                            }
                        }
                    }
                }
            });

        } catch (e){
            console.error(e);
            alert('íšŒì› ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    document.addEventListener('DOMContentLoaded', loadMemberDashboard);
</script>
</body>
</html>